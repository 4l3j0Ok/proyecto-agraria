name: Build and Release Windows Application

on:
  push:
    tags:
      - "*.*.*"

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $v = "${{ github.ref_name }}" -replace '^v',''
          echo "VERSION=$v" >> $env:GITHUB_OUTPUT

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - run: dotnet restore src/GestionAgraria.sln
      - run: dotnet publish src/GestionAgraria.csproj -c Release -o publish --self-contained false

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Create installer script
        shell: pwsh
        run: |
          $v = "${{ steps.version.outputs.VERSION }}"
          @"
          [Setup]
          AppName=Gesti贸n Agraria
          AppVersion=$v
          DefaultDirName={pf}\Gesti贸n Agraria
          DefaultGroupName=Gesti贸n Agraria
          OutputBaseFilename=GestionAgraria-$v
          SetupIconFile=src\Views\Assets\Icons\Icon.ico
          UninstallDisplayIcon={app}\GestionAgraria.exe
          Compression=lzma
          SolidCompression=yes
          AllowNoIcons=yes
          PrivilegesRequired=lowest
          WizardStyle=modern

          [Files]
          Source: "publish\*"; DestDir: "{app}"; Flags: recursesubdirs

          [Icons]
          Name: "{group}\Gesti贸n Agraria"; Filename: "{app}\GestionAgraria.exe"
          Name: "{commondesktop}\Gesti贸n Agraria"; Filename: "{app}\GestionAgraria.exe"

          [Run]
          Filename: "{app}\GestionAgraria.exe"; Description: "Iniciar Gesti贸n Agraria"; Flags: nowait postinstall skipifsilent
          "@ | Set-Content installer.iss

      - name: Build installer
        run: iscc installer.iss

      - uses: actions/upload-artifact@v4
        with:
          name: GestionAgraria-${{ steps.version.outputs.VERSION }}
          path: |
            publish/
            Output/*.exe

      - name: Create GitHub Release
        id: release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Gesti贸n Agraria ${{ github.ref_name }}
          body: |
            ##  Release ${{ github.ref_name }}
            Descarg谩 `GestionAgraria-${{ steps.version.outputs.VERSION }}.exe`.

      - name: Upload installer to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: Output/GestionAgraria-${{ steps.version.outputs.VERSION }}.exe
          asset_name: GestionAgraria-${{ steps.version.outputs.VERSION }}.exe
          asset_content_type: application/vnd.microsoft.portable-executable

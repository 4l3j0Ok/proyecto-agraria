name: Build and Release Windows Application

on:
  push:
    tags:
      - "*.*.*" # Triggers on version tags like 1.0.0

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write # Required for creating releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: get_version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore src/GestionAgraria.sln

      - name: Build solution
        run: dotnet build src/GestionAgraria.sln --configuration Release --no-restore

      - name: Publish application
        run: dotnet publish src/GestionAgraria.csproj --configuration Release --no-build --output ./publish --self-contained false

      - name: Install WiX Toolset
        shell: pwsh
        run: |
          dotnet tool install --global wix --version 5.0.2
          wix --version

      - name: Download WiX UI Extension
        shell: pwsh
        run: |
          # Create extensions directory
          $extDir = "${{ github.workspace }}\wixext"
          New-Item -ItemType Directory -Force -Path $extDir

          # Download WiX UI extension package
          Invoke-WebRequest -Uri "https://www.nuget.org/api/v2/package/WixToolset.UI.wixext/5.0.2" -OutFile "$extDir\WixToolset.UI.wixext.nupkg"

          # Extract the package (it's a zip file)
          Expand-Archive -Path "$extDir\WixToolset.UI.wixext.nupkg" -DestinationPath "$extDir\WixToolset.UI.wixext" -Force

          Write-Host "‚úì WiX UI extension downloaded and extracted"

          # List contents to find the actual DLL location
          Write-Host "Searching for DLL..."
          Get-ChildItem -Path "$extDir\WixToolset.UI.wixext" -Recurse -Filter "*.dll" | Select-Object FullName

      - name: Generate WiX source file
        shell: pwsh
        run: |
          $publishDir = "${{ github.workspace }}\publish"
          $iconPath = "${{ github.workspace }}\src\Views\Assets\Icons\Icon.ico"
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $outputPath = "${{ github.workspace }}\installer\Product.wxs"

          # Run the generation script
          & "installer/Generate-WixSource.ps1" `
            -Version $version `
            -PublishDir $publishDir `
            -IconPath $iconPath `
            -OutputPath $outputPath

      - name: Build MSI Installer
        shell: pwsh
        run: |
          cd installer

          # Find the WiX extension DLL dynamically
          $extDir = "${{ github.workspace }}\wixext\WixToolset.UI.wixext"
          $extDll = Get-ChildItem -Path $extDir -Recurse -Filter "WixToolset.UI.wixext.dll" | Select-Object -First 1 -ExpandProperty FullName

          if (-not $extDll) {
            Write-Error "‚úó WiX UI extension DLL not found!"
            Get-ChildItem -Path $extDir -Recurse | Select-Object FullName
            exit 1
          }

          Write-Host "Using extension: $extDll"

          # Build with WiX v5 - interactive installer with UI
          wix build Product.wxs `
            -out GestionAgraria-${{ steps.get_version.outputs.VERSION }}.msi `
            -ext $extDll `
            -arch x64

          if (Test-Path "GestionAgraria-${{ steps.get_version.outputs.VERSION }}.msi") {
            Write-Host "‚úì MSI created successfully"
            $size = (Get-Item "GestionAgraria-${{ steps.get_version.outputs.VERSION }}.msi").Length / 1MB
            Write-Host "‚úì Size: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "‚úó MSI creation failed"
            exit 1
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GestionAgraria-${{ steps.get_version.outputs.VERSION }}
          path: |
            ./publish/
            ./installer/*.msi
          retention-days: 90

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Gesti√≥n Agraria ${{ github.ref_name }}
          body: |
            ## üöÄ Release ${{ github.ref_name }}

            ### üì¶ Instalador Windows
            Descarga el archivo `GestionAgraria-${{ steps.get_version.outputs.VERSION }}.msi` para instalar la aplicaci√≥n.

            ### üìã Requisitos
            - Windows 10 o superior
            - .NET 8.0 Runtime (se incluye en el instalador)

            ### üîß Instalaci√≥n
            1. Descarga el archivo MSI
            2. Ejecuta el instalador
            3. Sigue las instrucciones en pantalla

            ### üìù Cambios
            Ver el historial de commits para m√°s detalles.
          draft: false
          prerelease: false

      - name: Upload MSI to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./installer/GestionAgraria-${{ steps.get_version.outputs.VERSION }}.msi
          asset_name: GestionAgraria-${{ steps.get_version.outputs.VERSION }}.msi
          asset_content_type: application/x-msi
